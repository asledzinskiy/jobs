- job-template:
    name: mcp-k8s-e2e-{test_name}
    description: |
      Kubernetes e2e conformance tests
    node: k8s-e2e
    builders:
      - inject:
          properties-content: |
            PATH=$PATH:/usr/local/go/bin
            GOPATH=$WORKSPACE/_gopath
            ARTIFACTS=$WORKSPACE/_artifacts
            GERRIT_PROJECT=kubernetes/kubernetes
            KUBERNETES_VAGRANT_USE_NFS=true
            KUBERNETES_PROVIDER=vagrant
            NUM_NODES=2
            KUBERNETES_MEMORY=3072
      - shell:
          !include-raw-escape builders/mcp-k8s-e2e.sh

    concurrent: true

    parameters:
        - string:
            name: GERRIT_REFSPEC
            default: refs/heads/release-1.3

    wrappers:
      - ansicolor
      - workspace-cleanup
      - ssh-agent-credentials:
          users:
            - 'mcp-ci-gerrit'

    publishers:
      - post-tasks:
        - matches:
          - log-text: '.'
          escalate-status: true
          script: |
            ./cluster/kube-down.sh
            sudo chown -R jenkins:jenkins "${{WORKSPACE}}"
      - junit:
          results: '_artifacts/**.xml'

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
          projects:
            - project-compare-type: PLAIN
              project-pattern: kubernetes/kubernetes
              branches:
                - branch-compare-type: ANT
                  branch-pattern: '**'
          custom-url: '* $JOB_NAME $BUILD_URL'

- project:
    name: mcp-k8s-e2e
    test_name: conformance
    jobs:
      - 'mcp-k8s-e2e-{test_name}'
