- job-template:
    name: '{project-name}.system-test.{test-name}'
    description: 'Run system test "{test-name}" for "{project-name}" project'
    node: 'system-test'
    concurrent: false
    timeout: '180'
    weight: '1'
    envname: "$JOB_NAME"
    netchecker-agent-dir: "${{WORKSPACE}}/mcp-netchecker-agent"
    netchecker-server-dir: "${{WORKSPACE}}/mcp-netchecker-server"
    pre-script: |
        if [ -n "$IMAGE_LINK" ]; then
          mkdir -p $(dirname "$IMAGE_PATH")
          pushd $(dirname "$IMAGE_PATH")
          wget -qN "$IMAGE_LINK"
          popd
        fi
    post-script: |
        source "$VENV_PATH/bin/activate"
        dos.py destroy "$ENV_NAME" || true
    logrotate:
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
      daysToKeep: 30
      numToKeep: 50

    parameters:
    - string:
        name: IMAGE_LINK
        default: '{image_link}'
        description: "Which image to use in tests"

    - string:
        name: IMAGE_PATH
        default: '{image_path}'
        description: "Local path to the image"

    - string:
        name: TEST_PATH
        default: "fuel_ccp_tests/tests/system/test_netchecker.py"
        description: "Path to the test module/class/function"

    - string:
        name: TEST_EXPRESSION
        default: "none"
        description: "Tests will be executed with '-k' option. Example: 'test_method or test other'"

    - string:
        name: VERBOSE
        default: "true"

    - string:
        name: FUEL_CCP_TESTS_COMMIT
        default: 'master'
        description: "fuel-ccp-tests commit"

    - string:
        name: FUEL_CCP_TESTS_REFS
        default: 'none'
        description: 'Refspecs for commits in fuel-ccp-tests gerrit separated by spaces. For example, refs/changes/10/55310/1 refs/changes/10/55310/2'

    - string:
        name: FUEL_CCP_INSTALLER_COMMIT
        default: 'master'
        description: "fuel-ccp-installer commit"

    - string:
        name: FUEL_CCP_INSTALLER_REFS
        default: 'none'
        description: 'Refspecs for commits in fuel-ccp-installer gerrit separated by spaces. For example, refs/changes/10/55310/1 refs/changes/10/55310/2'

    - string:
        name: DEPLOY_SCRIPT_REL_PATH
        default: 'utils/jenkins/kargo_deploy.sh'
        description: "Relative path to the deployment script (fuel-ccp-installer)"

    - string:
        name: VENV_PATH
        default: '/home/jenkins/venv-fuel-devops-3.0/'
        description: "Path to the python virtual environment for fuel-ccp-tests"

    - string:
        name: DEVOPS_DB_NAME
        default: '/home/jenkins/venv-fuel-devops-3.0.sqlite3.db'
        description: "Name of Postgresql DB or path to the sqlite DB file"

    - string:
        name: DEVOPS_DB_ENGINE
        default: 'django.db.backends.sqlite3'
        description: "DB engine for fuel-devops: 'django.db.backends.sqlite3' or 'django.db.backends.postgresql_psycopg2'"

    - string:
        name: KEEP_BEFORE
        default: 'yes'
        description: 'If yes/true, then DO NOT ERASE existing environment'

    - string:
        name: KEEP_AFTER
        default: 'yes'
        description: 'If yes/true, then DO NOT ERASE existing environment'

    - string:
         name: GERRIT_REFSPEC
         default: 'refs/heads/master'

    - text:
        name: ADDITIONAL_PARAMETERS
        description: |
          NAME1=VALUE1</br>
          NAME1=VALUE1

    properties:
    - heavy-job:
        weight: '{weight}'

    scm:
      - git:
          url: 'https://github.com/openstack/fuel-ccp-tests'
          branches:
           - "$FUEL_CCP_TESTS_COMMIT"

      - git:
          url: 'https://github.com/openstack/fuel-ccp-installer'
          branches:
           - "$FUEL_CCP_INSTALLER_COMMIT"
          basedir: 'fuel-ccp-installer'

      - git:
           url: 'ssh://mcp-ci-gerrit@{gerrit-host}:29418/{project-space}/{project-to-clone}'
           credentials-id: 'mcp-ci-gerrit'
           branches:
            - 'master'
           basedir: '{project-to-clone}'

      - git:
           remotes:
             - gerrit:
                 url: 'ssh://mcp-ci-gerrit@{gerrit-host}:29418/{project-space}/{project-name}'
                 refspec: '$GERRIT_REFSPEC'
                 credentials-id: 'mcp-ci-gerrit'
           branches:
            - 'master'
           basedir: '{project-name}'

    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
          projects:
            - project-compare-type: PLAIN
              project-pattern: '{project-space}/{project-name}'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: '**'
          custom-url: '* $JOB_NAME $BUILD_URL'
          skip-vote:
              successful: true
              failed: true
              unstable: true
              notbuilt: true

    builders:
      - inject:
          properties-content: |
            CONNECTION_STRING=qemu+tcp://127.0.0.1:16509/system
            ENV_NAME={envname}
            NETCHECKER_AGENT_DIR={netchecker-agent-dir}
            NETCHECKER_SERVER_DIR={netchecker-server-dir}

      - inject:
          properties-content: $ADDITIONAL_PARAMETERS

      - shell: |
          #!/bin/bash -xe
          echo "=== [systest PRE-script] ==="
          {pre-script}
      - shell:
          !include-raw-escape: builders/system-test.sh

      - shell: |
          #!/bin/bash -xe
          echo "=== [systest POST-script] ==="
          {post-script}

    publishers:
    - archive:
        allow-empty: true
        artifacts: '**/nosetests.xml,logs/*,tests.log,*.txt'
        latest-only: false
    - junit:
        keep-long-stdio: false
        results: '**/nosetests.xml'
