- job-template:
    name: sync-upstream
    disabled: true
    description: |
      Sync upstream repos to downstream
    node: sync-code
    builders:
      - shell:
          !include-raw-escape '../../builders/sync-upstream.sh'
    concurrent: false

    parameters:
      - string:
          name: GIT_PUSH_USERNAME
          default: "mcp-ci-mirroring"
          description: "Pushing username"
      - string:
          name: GERRIT_HOST
          default: '{gerrit-host}'
      - string:
          name: PUSH_FORCE
          default: 'false'
          description: "Force push during repo sync"

    scm:
      - git:
         url: '{gerrit-url}/mcp-ci/gitrepo'
         branches:
          - 'master'

    wrappers:
      - workspace-cleanup
      - ssh-agent-credentials:
          users:
            - 'mcp-ci-mirroring'
    triggers:
      - timed: '*/15 * * * *'

- job-template:
    name: sync-upstream-{project-namespace}
    description: |
      Sync upstream repos to downstream
    node: sync-code
    builders:
      - shell: |
          #!/bin/bash -xe
          VENV="${{WORKSPACE}}_VENV"

          virtualenv "${{VENV}}"
          source "${{VENV}}/bin/activate" || exit 1

          pip install .

          #FIXME(skulanov) remove after implementing support in gitrepo
          sed -i 's/${{GERRIT_HOST}}/{gerrit-host}/g' ${{WORKSPACE}}/project-config/sync-projects/{project-namespace}.yaml

          gitrepo sync ${{WORKSPACE}}/project-config/sync-projects/{project-namespace}.yaml
    concurrent: false

    parameters:
      - string:
          name: GERRIT_HOST
          default: '{gerrit-host}'

    scm:
      - git:
         url: '{gerrit-url}/mcp-ci/gitrepo'
         branches:
          - 'master'

      - git:
          url: '{gerrit-url}/mcp-ci/project-config'
          branches:
           - 'master'
          basedir: 'project-config'

    wrappers:
      - workspace-cleanup
      - ssh-agent-credentials:
          users:
            - 'mcp-ci-mirroring'
    # FIXME(skulanov) Let's disable before manual tests
    # triggers:
    #   - timed: '*/15 * * * *'
