- job-template:
    name: build-docker-openstack-{version}-{branch}-{os-project}
    description: |
      Build docker image for OpenStack projects
    project-type: workflow
    concurrent: false
    parameters:
    - tcp-common-params:
        gerrit-host: '{gerrit-host}'
        gerrit-port: '{gerrit-port}'
        artifactory-url: '{artifactory-url}'
        out-repo: 'out-docker-{os-project}'
        artifactory-docker: '{artifactory-docker}'
        pipelines-lib: 'tcp/ccp-pipeline-libs'
    - tcp-openstack-params:
        source-gerrit-host: 'review.fuel-infra.org'
        source-gerrit-port: '{gerrit-port}'
        source-gerrit-user: 'mcp-openstack-reader'
        branch: 'stable/{branch}'
        requirements-project: 'openstack/requirements'
    - tcp-source-params:
        source-gerrit-host: 'review.fuel-infra.org'
        source-gerrit-port: '{gerrit-port}'
        source-gerrit-user: 'mcp-openstack-reader'
        source-credentials: 'mcp-openstack-reader'
        project: 'openstack/{os-project}'
        branch: '{version}/{branch}'

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
          projects:
            - project-compare-type: PLAIN
              project-pattern: 'tcp/ccp-docker-{os-project}'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: 'master'
          custom-url: '* $JOB_NAME $BUILD_URL'

    workflow-scm:
      scm:
        basic-scm:
          branch: 'master'
          project: 'tcp/ccp-docker-{os-project}'
          gerrit-host: '{gerrit-host}'
          gerrit-port: '{gerrit-port}'
      script-path: Jenkinsfile

- job-template:
    name: build-docker-openstack-{version}-{branch}-neutron
    description: |
      Build docker image for OpenStack Neutron
    project-type: workflow
    concurrent: false
    parameters:
    - tcp-common-params:
        gerrit-host: '{gerrit-host}'
        gerrit-port: '{gerrit-port}'
        artifactory-url: '{artifactory-url}'
        out-repo: 'out-docker-neutron'
        artifactory-docker: '{artifactory-docker}'
        pipelines-lib: 'tcp/ccp-pipeline-libs'
    - tcp-openstack-params:
        source-gerrit-host: 'review.fuel-infra.org'
        source-gerrit-port: '{gerrit-port}'
        source-gerrit-user: 'mcp-openstack-reader'
        branch: 'stable/{branch}'
        requirements-project: 'openstack/requirements'
    - tcp-source-params:
        source-gerrit-host: 'review.fuel-infra.org'
        source-gerrit-port: '{gerrit-port}'
        source-gerrit-user: 'mcp-openstack-reader'
        source-credentials: 'mcp-openstack-reader'
        project: 'openstack/neutron'
        branch: '{version}/{branch}'
    - string:
        name: CONTRAIL_PLUGIN_SOURCE_URL
        default: 'ssh://mcp-ci-gerrit@{gerrit-host}:{gerrit-port}/tcp/contrail-neutron-plugin'
    - string:
        name: CONTRAIL_PLUGIN_SOURCE_BRANCH
        default: 'R3.0.2.x'
    - string:
        name: PYTHON_IFMAP_SOURCE_URL
        default: 'ssh://mcp-ci-gerrit@{gerrit-host}:{gerrit-port}/tcp/ifmap-python-client'
    - string:
        name: PYTHON_IFMAP_SOURCE_BRANCH
        default: 'master'
    - string:
        name: CONTRAIL_CONTROLLER_SOURCE_URL
        default: 'ssh://mcp-ci-gerrit@{gerrit-host}:{gerrit-port}/tcp/contrail-controller'
    - string:
        name: CONTRAIL_CONTROLLER_SOURCE_BRANCH
        default: 'R3.0.2.x'

    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
          projects:
            - project-compare-type: PLAIN
              project-pattern: 'tcp/ccp-docker-neutron'
              branches:
                - branch-compare-type: ANT
                  branch-pattern: 'master'
          custom-url: '* $JOB_NAME $BUILD_URL'

    workflow-scm:
      scm:
        basic-scm:
          branch: 'master'
          project: 'tcp/ccp-docker-neutron'
          gerrit-host: '{gerrit-host}'
          gerrit-port: '{gerrit-port}'
      script-path: Jenkinsfile
