- job-template:
    name: 'calico.system-test.{test-name}'
    description: 'Run system test "{test-name}" for "Calico" project'
    node: 'system-test'
    concurrent: true
    timeout: '60'
    weight: '1'
    envname: "$JOB_NAME.$BUILD_NUMBER"
    netchecker-agent-dir: "$WORKSPACE/mcp-netchecker-agent"
    netchecker-server-dir: "$WORKSPACE/mcp-netchecker-server"
    pre-script: |
        if [ -n "$IMAGE_LINK" ]; then
          mkdir -p $(dirname "$IMAGE_PATH")
          pushd $(dirname "$IMAGE_PATH")
          wget -N "$IMAGE_LINK"
          popd
        fi
    post-script: |
        source "$VENV_PATH/bin/activate"
        dos.py destroy "$ENV_NAME" || true
    logrotate:
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
      daysToKeep: 30
      numToKeep: 50

    parameters:
    - string:
        name: MCP_NETCHECKER_AGENT_IMAGE_REPO
        default: '{mcp-k8s-ci-registry}/mcp-netchecker/agent'

    - string:
        name: MCP_NETCHECKER_AGENT_VERSION
        default: 'mcp-0.1'

    - string:
        name: MCP_NETCHECKER_SERVER_IMAGE_REPO
        default: '{mcp-k8s-ci-registry}/mcp-netchecker/server'

    - string:
        name: MCP_NETCHECKER_SERVER_VERSION
        default: 'mcp-0.1'

    - string:
        name: HYPERKUBE_IMAGE_REPO
        default: 'artifactory.mcp.mirantis.net:5002/hyperkube-amd64'

    - string:
        name: HYPERKUBE_IMAGE_TAG
        default: 'latest'

    - string:
        name: IMAGE_LINK
        default: '{image_link}'
        description: "Which image to use in tests"

    - string:
        name: IMAGE_PATH
        default: '{image_path}'
        description: "Local path to the image"

    - string:
        name: TEST_PATH
        default: "fuel_ccp_tests/tests/system/test_calico.py"
        description: "Path to the test module/class/function"

    - string:
        name: TEST_EXPRESSION
        default: "none"
        description: "Tests will be executed with '-k' option. Example: 'test_method or test other'"

    - string:
        name: VERBOSE
        default: "true"

    - string:
        name: FUEL_CCP_TESTS_COMMIT
        default: 'master'
        description: "fuel-ccp-tests commit"

    - string:
        name: FUEL_CCP_TESTS_REFS
        default: 'none'
        description: 'Refspecs for commits in fuel-ccp-tests gerrit separated by spaces. For example, refs/changes/10/55310/1 refs/changes/10/55310/2'

    - string:
        name: FUEL_CCP_INSTALLER_COMMIT
        default: 'master'
        description: "fuel-ccp-installer commit"

    - string:
        name: FUEL_CCP_INSTALLER_REFS
        default: 'none'
        description: 'Refspecs for commits in fuel-ccp-installer gerrit separated by spaces. For example, refs/changes/10/55310/1 refs/changes/10/55310/2'

    - string:
        name: DEPLOY_SCRIPT_REL_PATH
        default: 'utils/jenkins/kargo_deploy.sh'
        description: "Relative path to the deployment script (fuel-ccp-installer)"

    - string:
        name: VENV_PATH
        default: '/home/jenkins/venv-fuel-devops-3.0/'
        description: "Path to the python virtual environment for fuel-ccp-tests"

    - string:
        name: DEVOPS_DB_NAME
        default: '/home/jenkins/venv-fuel-devops-3.0.sqlite3.db'
        description: "Name of Postgresql DB or path to the sqlite DB file"

    - string:
        name: DEVOPS_DB_ENGINE
        default: 'django.db.backends.sqlite3'
        description: "DB engine for fuel-devops: 'django.db.backends.sqlite3' or 'django.db.backends.postgresql_psycopg2'"

    - string:
        name: KEEP_BEFORE
        default: 'no'
        description: 'If yes/true, then DO NOT ERASE existing environment'

    - string:
        name: KEEP_AFTER
        default: 'yes'
        description: 'If yes/true, then DO NOT ERASE existing environment'

    - string:
         name: GERRIT_REFSPEC
         default: 'refs/heads/master'

    - string:
        name: GERRIT_CHANGE_NUMBER
        default: ''
        description: gerrit change number from upstream job
    - string:
        name: CALICO_GERRIT_REFSPEC
        default: ''
        description: gerrit refspec from upstream job
    - string:
        name: CALICO_GERRIT_PROJECT
        default: ''
        description: gerrit project from upstream job
    - string:
        name: CALICO_REPO
        default: ''
        description: custom path to git calico repo
    - string:
        name: CALICO_GERRIT_BRANCH
        default: ''
        description: gerrit branch from upstream job
    - string:
        name: CALICO_NODE_IMAGE_REPO
        default: ''
        description: custom node image path from upstream job
    - string:
        name: CALICOCTL_IMAGE_REPO
        default: ''
        description: custom path to calicoctl from upstream job
    - string:
        name: CALICO_VERSION
        default: ''
        description: calico version from upstream job

    - text:
        name: ADDITIONAL_PARAMETERS
        description: |
          NAME1=VALUE1</br>
          NAME1=VALUE1

    properties:
      - heavy-job:
          weight: '{weight}'
      - throttle:
          max-per-node: 1
          option: project

    scm:
      - git:
          url: 'https://github.com/openstack/fuel-ccp-tests'
          branches:
           - "$FUEL_CCP_TESTS_COMMIT"

      - git:
          url: 'https://github.com/openstack/fuel-ccp-installer'
          branches:
           - "$FUEL_CCP_INSTALLER_COMMIT"
          basedir: 'fuel-ccp-installer'

      - git:
           url: 'ssh://mcp-ci-gerrit@{gerrit-host}:29418/mcp-netchecker/mcp-netchecker-agent'
           credentials-id: 'mcp-ci-gerrit'
           branches:
            - 'master'
           basedir: 'mcp-netchecker-agent'

      - git:
           url: 'ssh://mcp-ci-gerrit@{gerrit-host}:29418/mcp-netchecker/mcp-netchecker-server'
           credentials-id: 'mcp-ci-gerrit'
           branches:
            - 'master'
           basedir: 'mcp-netchecker-server'

    wrappers:
    - credentials-binding:
      - username-password-separated:
          credential-id: 'artifactory'
          username: ARTIFACTORY_LOGIN
          password: ARTIFACTORY_PASSWORD
    - timeout:
        fail: false
        timeout: '{timeout}'
        write-description: false
    - ansicolor:
        colormap: xterm

    builders:
      - inject:
          properties-content: |
            CONNECTION_STRING=qemu+tcp://127.0.0.1:16509/system
            ENV_NAME={envname}
            NETCHECKER_AGENT_DIR={netchecker-agent-dir}
            NETCHECKER_SERVER_DIR={netchecker-server-dir}
            ARTIFACTORY_URL={artifactory-url}

      - inject:
          properties-content: $ADDITIONAL_PARAMETERS

      - shell: |
          #!/bin/bash -xe
          echo "=== [systest PRE-script] ==="
          {pre-script}
      - shell:
          !include-raw-escape: builders/system-test.sh

      - shell: |
          #!/bin/bash -xe
          echo "=== [systest POST-script] ==="
          {post-script}

    publishers:
    - post-destroy-vms # Destroy envs if left undestroyed
    - archive:
        allow-empty: true
        artifacts: '**/nosetests.xml,logs/*,tests.log,*.txt'
        latest-only: false
    - junit:
        keep-long-stdio: false
        results: '**/nosetests.xml'
